<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script type="module" crossorigin src="/assets/index-gjOK_Q4b.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/index-cOskUN71.css">
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #root {
      min-height: 100vh;
    }
    .chat-section {
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
      background-color: #1e2936;
      border-radius: 10px;
    }
    .chat-header {
      background-color: #007bff;
      color: #fff;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      border-radius: 10px 10px 0 0;
    }
    .chat-messages {
      min-height: 300px;
      max-height: 400px;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background-color: #2d3748;
    }
    .message {
      padding: 10px 15px;
      border-radius: 15px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .message.user {
      background-color: #dcf8c6;
      align-self: flex-end;
      margin-left: auto;
      color: #000;
    }
    .message.agent {
      background-color: #e0e0e0;
      align-self: flex-start;
      margin-right: auto;
      color: #000;
    }
    .chat-input-container {
      display: flex;
      padding: 15px;
      background-color: #2d3748;
      border-radius: 0 0 10px 10px;
      gap: 10px;
    }
    .chat-input {
      flex-grow: 1;
      padding: 10px 15px;
      border: 1px solid #4a5568;
      border-radius: 20px;
      background-color: #1e2936;
      color: #fff;
      outline: none;
    }
    .chat-input::placeholder {
      color: #a0aec0;
    }
    .chat-button {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
    }
    .chat-button:hover {
      background-color: #0056b3;
    }
    .settings-section {
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
      background-color: #1e2936;
      border-radius: 10px;
    }
    .settings-header {
      background-color: #28a745;
      color: #fff;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
    }
    .settings-content {
      padding: 20px;
      background-color: #2d3748;
      border-radius: 0 0 10px 10px;
      display: none;
    }
    .settings-content.open {
      display: block;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .settings-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .settings-field label {
      color: #a0aec0;
      font-size: 14px;
      font-weight: 500;
    }
    .settings-field input,
    .settings-field select {
      padding: 10px 15px;
      border: 1px solid #4a5568;
      border-radius: 8px;
      background-color: #1e2936;
      color: #fff;
      outline: none;
    }
    .settings-field input::placeholder {
      color: #718096;
    }
    .settings-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .settings-button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .settings-button.save {
      background-color: #28a745;
      color: #fff;
    }
    .settings-button.save:hover {
      background-color: #218838;
    }
    .settings-button.cancel {
      background-color: #6c757d;
      color: #fff;
    }
    .settings-button.cancel:hover {
      background-color: #5a6268;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <div class="settings-section">
    <div class="settings-header" id="settings-header">‚öôÔ∏è Settings</div>
    <div class="settings-content" id="settings-content">
      <div class="settings-grid">
        <div class="settings-field">
          <label for="openrouter-api-key">OpenRouter API Key</label>
          <input type="password" id="openrouter-api-key" placeholder="Enter your OpenRouter API key">
        </div>
        <div class="settings-field">
          <label for="ai-model">AI Model</label>
          <select id="ai-model">
            <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
            <option value="gpt-4.1-nano">GPT-4.1 Nano</option>
            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
          </select>
        </div>
        <div class="settings-field">
          <label for="kie-api-key">KIE API Key</label>
          <input type="password" id="kie-api-key" placeholder="Enter your KIE API key">
        </div>
        <div class="settings-field">
          <label for="fb-access-token">Facebook Access Token</label>
          <input type="password" id="fb-access-token" placeholder="Enter your Facebook access token">
        </div>
        <div class="settings-field">
          <label for="ad-account-id">Ad Account ID</label>
          <input type="text" id="ad-account-id" placeholder="e.g., act_283244530805042">
        </div>
        <div class="settings-field">
          <label for="page-id">Page ID</label>
          <input type="text" id="page-id" placeholder="Enter your Facebook Page ID">
        </div>
        <div class="settings-field">
          <label for="run-interval">Run Interval (seconds)</label>
          <input type="number" id="run-interval" placeholder="e.g., 900">
        </div>
        <div class="settings-field">
          <label for="ads-per-run">Ads Per Run</label>
          <input type="number" id="ads-per-run" placeholder="e.g., 1">
        </div>
        <div class="settings-field">
          <label for="daily-budget">Daily Budget ($)</label>
          <input type="number" id="daily-budget" placeholder="e.g., 500">
        </div>
      </div>
      <div class="settings-actions">
        <button class="settings-button cancel" id="cancel-settings">Cancel</button>
        <button class="settings-button save" id="save-settings">Save Settings</button>
      </div>
    </div>
  </div>

  <div class="chat-section">
    <div class="chat-header">üí¨ Chat with Meta Ads AI Agent</div>
    <div id="chat-messages" class="chat-messages"></div>
    <div class="chat-input-container">
      <input type="text" id="chat-input" class="chat-input" placeholder="Type a message...">
      <button id="chat-send-button" class="chat-button">Send</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const chatMessages = document.getElementById("chat-messages");
      const chatInput = document.getElementById("chat-input");
      const chatSendButton = document.getElementById("chat-send-button");
      const settingsHeader = document.getElementById("settings-header");
      const settingsContent = document.getElementById("settings-content");
      const saveSettingsButton = document.getElementById("save-settings");
      const cancelSettingsButton = document.getElementById("cancel-settings");

      const API_BASE_URL = window.location.origin;

      // Load settings from localStorage
      function loadSettings() {
        const settings = JSON.parse(localStorage.getItem("dashboardSettings") || "{}");
        document.getElementById("openrouter-api-key").value = settings.openrouterApiKey || "";
        document.getElementById("ai-model").value = settings.aiModel || "gpt-4.1-mini";
        document.getElementById("kie-api-key").value = settings.kieApiKey || "";
        document.getElementById("fb-access-token").value = settings.fbAccessToken || "";
        document.getElementById("ad-account-id").value = settings.adAccountId || "";
        document.getElementById("page-id").value = settings.pageId || "";
        document.getElementById("run-interval").value = settings.runInterval || "";
        document.getElementById("ads-per-run").value = settings.adsPerRun || "";
        document.getElementById("daily-budget").value = settings.dailyBudget || "";
      }

      // Save settings to localStorage and send to backend
      async function saveSettings() {
        const settings = {
          openrouterApiKey: document.getElementById("openrouter-api-key").value,
          aiModel: document.getElementById("ai-model").value,
          kieApiKey: document.getElementById("kie-api-key").value,
          fbAccessToken: document.getElementById("fb-access-token").value,
          adAccountId: document.getElementById("ad-account-id").value,
          pageId: document.getElementById("page-id").value,
          runInterval: document.getElementById("run-interval").value,
          adsPerRun: document.getElementById("ads-per-run").value,
          dailyBudget: document.getElementById("daily-budget").value
        };
        localStorage.setItem("dashboardSettings", JSON.stringify(settings));
        
        try {
          const response = await fetch(`${API_BASE_URL}/api/settings`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(settings)
          });
          if (response.ok) {
            alert("Settings saved successfully!");
            settingsContent.classList.remove("open");
          } else {
            alert("Failed to save settings to backend.");
          }
        } catch (error) {
          console.error("Error saving settings:", error);
          alert("Error saving settings. Please try again.");
        }
      }

      // Toggle settings panel
      settingsHeader.addEventListener("click", () => {
        settingsContent.classList.toggle("open");
      });

      saveSettingsButton.addEventListener("click", saveSettings);
      cancelSettingsButton.addEventListener("click", () => {
        settingsContent.classList.remove("open");
      });

      loadSettings();

      function addMessage(sender, text) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", sender);
        messageDiv.textContent = text;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function sendMessage() {
        const messageText = chatInput.value.trim();
        if (messageText === "") return;

        addMessage("user", messageText);
        chatInput.value = "";

        try {
          const settings = JSON.parse(localStorage.getItem("dashboardSettings") || "{}");
          const response = await fetch(`${API_BASE_URL}/api/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              message: messageText,
              apiKey: settings.openrouterApiKey,
              model: settings.aiModel
            })
          });
          const data = await response.json();
          addMessage("agent", data.response);
        } catch (error) {
          console.error("Error sending message:", error);
          addMessage("agent", "Error: Could not connect to the agent.");
        }
      }

      chatSendButton.addEventListener("click", sendMessage);
      chatInput.addEventListener("keypress", (event) => {
        if (event.key === "Enter") {
          sendMessage();
        }
      });

      // WebSocket for real-time status updates
      const ws = new WebSocket(`wss://${window.location.host}/ws/status`);

      ws.onopen = () => {
        console.log("WebSocket connection established.");
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.success && data.services) {
          console.log("Received real-time status update:", data.services);
        }
      };

      ws.onclose = () => {
        console.log("WebSocket connection closed.");
      };

      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
      };
    });
  </script>
</body>

</html>

